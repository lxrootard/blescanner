<h1>Jeedom Plugin for managing Bluetooth Devices and ESP32 BLE Antennas with MQTT</h1>

<p><img src="../images/jeedom.png" alt="Jeedom Logo" title="" />
<img src="../images/blescanner_icon.png" alt="Plugin Logo" title="" />
<img src="../images/theengs_icon.png" alt="Plugin Logo" title="" /></p>

<p>This plugin discovers and manages Bluetooth devices and <a href="https://docs.openmqttgateway.com">OMG ESP32</a> BLE antennas. <a href="https://gateway.theengs.io">Theengs</a> antennas are also recognized, but their parameters are not (yet?) available due to lack of Home Assistant auto-discovery support. The plugin does not replace the <a href="https://mips2648.github.io/jeedom-plugins-docs/tgw/en_US/">#plugin-theengs</a> to deploy and manage Theengs antennas.</p>

<h2>Documentation</h2>

<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#auto-discovery">Auto-Discovery</a></li>
<li><a href="#unknown-devices-list">Unknown Devices List</a></li>
<li><a href="#unknown-devices-network">Unknown Devices Network</a></li>
<li><a href="#known-devices-list">Known Devices List</a></li>
<li><a href="#known-devices-network">Known Devices Network</a></li>
<li><a href="#devices-and-antennas">Devices and Antennas</a></li>
<li><a href="#antennas-health">Antennas Health</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#bugs-and-troubleshooting">Bugs and Troubleshooting</a></li>
</ul>

<h3>Prerequisites</h3>

<p>The plugin expects the broker to publish one or several root<em>topics that each group one or several antennas. The auto-discovery topic is optional, if it's not provided only presence will be available on the equipments.
The expected structure is the following:
<code>
/root_topic1/antenne1
/root_topic1/antenne2
/root_topic2/antenne3
...
/topic_de_d√©couverte
</code>
Here's an example of a single root</em>topic <code>theengs</code> with 2 antennas <code>tgw_local</code>and <code>tgw_remote</code>.
<br> <code>LWT</code> and <code>BTtoMQTT</code> must appear under each antenna:</p>

<p><img src="../images/mqttexplorer.png" alt="#mqttexplorer" title="" /></p>

<h3>Configuration</h3>

<h4>Local MQTT broker (MQTT2)</h4>

<p>Using this mode the plugin uses the <code>MQTT2</code> configuration (if installed) <br>
The <code>MQTT2</code> plugin startup is automatic.
<img src="../images/blescanner1.png" alt="config" title="" /></p>

<h4>External MQTT Broker</h4>

<p>Using this mode the MQTT broker is not managed by the plugin.
<br>It's mandatory to setup the MQTT connexion settings. </p>

<ul>
<li>Broker URL: default <code>mqtt://localhost:1883</code></li>
<li>Authentication: username and password</li>
</ul>

<p><img src="../images/blescanner12.png" alt="config" title="" /></p>

<h4>Common MQTT parameters</h4>

<ul>
<li>Discovery topic: Home Assistant compatible topic. Default: <code>homeassistant</code></li>
<li>Devices root topics: topics monitored by the plugin (at least one required). Sub-topics are not allowed.</li>
</ul>

<h4>Devices and Antennas</h4>

<ul>
<li>Auto creation: automatically create BLE devices (disabled by default)</li>
<li>Auto-discovery duration: detection delay for antennas and devices (in minutes)</li>
<li>Missing timeout: time after which inactive devices will be deleted (in minutes, 0 to keep them indefinitely)</li>
</ul>

<h4>System</h4>

<ul>
<li>Deamon port: default <code>55036</code>, do not change until you have a conflict</li>
</ul>

<p><img src="../images/blescanner1.png" alt="config" title="" /></p>

<h3>Auto-Discovery</h3>

<p>Auto-discovery is active on startup, and detected antennas are added automatically. You can also stop or restart it using the <code>Auto-discovery</code> button. <br />
If auto-creation is checked in the configuration page, devices will be automatically added at the end of synchronization.</p>

<p><img src="../images/blescanner2.png" alt="disco" title="" /></p>

<h3>Unknown Devices List</h3>

<p>Displays all unmanaged devices. The <code>Discoverable</code> column indicates whether the devices support auto-discovery. The <code>display absent devices</code> option allows to see auto-detected devices that are not reachable. You can also filter table rows by clicking on column headers. <br />
The <code>Add</code> button allows adding discovered devices one by one. If the device supports auto-discovery, its commands will be automatically created; otherwise only presence and RSSI will be available.</p>

<p><img src="../images/blescanner5.png" alt="list2" title="" /></p>

<h3>Unknown Devices Network</h3>

<p>Contextual display can be shown by signal attenuation or by distance (if supported by the antenna). <br />
It is activated by selecting a node. The animation can be paused and the graph can be zoomed.</p>

<p><img src="../images/blescanner6.png" alt="#network1" title="" /></p>

<h3>Known Devices List</h3>

<p>Displays already added devices. Missing devices can also be displayed, and you can filter table rows by clicking on column headers.</p>

<p><img src="../images/blescanner3.png" alt="list1" title="" /></p>

<h3>Known Devices Network</h3>

<p>Contextual display can be shown by attenuation or distance (if supported by the antenna). It is activated by selecting a node. The animation can be paused. Missing devices can also be filtered.</p>

<p><img src="../images/blescanner4.png" alt="#network1" title="" /></p>

<h3>Devices and Antennas</h3>

<p>Available commands depend on the type of device or antenna. <br />
A custom image can be added by device category.</p>

<p>Theengs antennas only support presence detection. ESP32 antennas provide several commands (see <code>Bluetooth</code> and <code>System</code> tabs). <br />
The <code>Web Console</code> button provides access to the ESP32 admin interface. <br />
For more info, see the <a href="https://docs.openmqttgateway.com/use/gateway.html#system-commands-esp-only">ESP32 commands reference</a></p>

<p><img src="../images/blescanner7.png" alt="Equipments" title="" /> <br />
<img src="../images/blescanner8.png" alt="Equipments" title="" /></p>

<h4>Custom Commands</h4>

<p>The <code>Custom</code> tab allows adding custom commands found in advertising data but not in auto-discovery (depending on the device). Example: temperature in Fahrenheit (<code>tempf</code>) for a reprogrammed Xiaomi <code>lywsd03mmc</code>.</p>

<p><img src="../images/blescanner11.png" alt="Configuration" title="" /></p>

<p>Similarly for missing <code>ESP32</code> commands like enabling/disabling external decoding or message count:</p>

<p><img src="../images/blescanner10.png" alt="Configuration" title="" /></p>

<p>For actions, the <code>payload</code> field must be in the format <code>"key1":value1 , "key2":value2...</code> <br />
Both advertising and auto-discovered data are available in the <code>Other Data</code> column of the <a href="#liste-des-devices-inconnus">Unknown Devices List</a> page.</p>

<h3>Antennas Health</h3>

<p><img src="../images/blescanner9.png" alt="Configuration" title="" /></p>

<h3>FAQ</h3>

<ul>
<li>Antennas are not detected or some devices are not shown as discoverable: <br />
Restart auto-discovery on your antennas (<code>BT: Force scan</code> or reboot the ESP32 or Theengs antenna)</li>
<li>ESP32 commands are not created: <br />
Enable the <code>SYS: Auto discovery</code> parameter</li>
<li>Advertising data not shown (ESP32): <br />
Enable <code>BT: Publish Advertisement data</code> parameter</li>
<li>Distances not shown: <br />
Only ESP32 reports this info starting from firmware v1.8 (experimental feature). Enable <code>BT: Publish HASS presence</code> for this.</li>
</ul>

<h3>Bugs and Troubleshooting</h3>

<p>See the <a href="https://community.jeedom.com/tag/plugin-blescanner">Jeedom community forum</a></p>
